<!DOCTYPE html>
<!--
Author: Wen Lin
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>State Election and Demographic Data</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="newcss.css">
        <script src='https://unpkg.com/@turf/turf/turf.min.js'></script>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
              integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="crossorigin=""/>
        <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
        <script language="javascript" type="text/javascript" src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
                integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="crossorigin="">
        </script>
    </head>
    <body onload="initLoad()">
        <div class="split left">
            <div class="centered">
                <h3>Information</h3>
                <div style="padding-bottom:10px">
                    <label for="States" style="font-size: 20px;padding-right: 26px">State:</label>
                    <select id="States" onchange="loadFeature()"> <!-- needs to be replaced by data from DB -->
                        <option value="State" onclick="">State</option>
                    </select>
                </div>
                <div id="searchWindow">
                    <input id="precinctSearch" type="text" placeholder="Search for Precinct" onkeyup="findPrecincts()">
                    <div id="searchResults"></div>
                </div>
                <div>
                    Selected Precinct: <label id="selectedPrecinct"></label>
                </div>
                <h4>Population:</h4>
                <label id="totVotePop"> X people</label>
                <table cellpadding="0">
                    <tr>
                        <td><label for="dataSection">Data Type:</label></td>
                        <td>
                            <select id="dataSection" onchange="switchDataSection()" style="">
                                <option value="none" selected>None</option>
                                <option value="election">Election</option>
                                <option value="demographic">Demographic</option>
                            </select>
                        </td>
                    </tr>
                    <tr id="electionDropdownArea" style="display:none">
                        <td><label for="year">Election Type:</label></td>
                        <td>
                            <select id="year" onchange="setElectionSection()" style="">
                                <option id="noElection" value="none" selected>None</option>
                                <option id="pred16" value="pred16">Presidential 2016</option>
                                <option id="cong16" value="cong16">Congressional 2016</option>
                                <option id="cong18" value="cong18">Congressional 2018</option>
                            </select>
                        </td>
                    </tr>
                </table>
                <br><br>
                <div id="electionSection">
                    <label>Democratic: </label><label id="demNum">X people [X%]</label><br/> <!-- needs to be replaced by DB data -->
                    <label>Republican: </label><label id="repNum">Y people [Y%]</label><br/> <!-- needs to be replaced by DB data -->
                    <label style="padding-right: 43px">Other:</label><label id="othNum">Z people [Z%]</label><br/> <!-- needs to be replaced by DB data -->
                    <br>
                </div>
                <div id="demographicSection">
                    <label>White: </label><label id="whiteNum" style="padding-left: 20px">X people</label><br/> <!-- needs to be replaced by DB data -->
                    <label>Black: </label><label id="blackNum" style="padding-left: 20px">Y people</label><br/> <!-- needs to be replaced by DB data -->
                    <label>Asian: </label><label id="asianNum" style="padding-left: 20px">Y people</label><br/> <!-- needs to be replaced by DB data -->
                    <label>Hispanic: </label><label id="hispanicNum">Y people</label><br/> <!-- needs to be replaced by DB data -->
                    <label>Other: </label><label id="otherNum" style="padding-left: 20px">Y people</label><br/> <!-- needs to be replaced by DB data -->
                </div>
                <div id="errorSection" style="display:none">
                    <h3>Error Type:</h3>
                    <div id="currentError"></div>
                    <br>
                    <label for="commentArea">Comments:</label><br>
                    <textarea placeholder="Type your comment for the resolved error" id="commentArea" name="commentArea" rows="2" cols="20"></textarea>
                </div>
                <p>Options:</p>
                <div id="optionSection">
                    <button onclick="openChangeDataSection()" style="width:auto;margin-right: 25px">Change Data</button>
                    <button onclick="document.getElementById('bordersPopup').style.display='block'" style="width:auto;">Fix Borders</button>
                    <br>
                </div>
                <br>
                <br>
                <button onclick="document.getElementById('errorPopup').style.display='block'" style="width:50px;height: 40px;"><img src="ee.png" alt="Error Log" style="width: 30px;height: 30px;"></button>
                <button onclick="document.getElementById('settingsPopup').style.display='block'" style="width:50px; height:40px"><img src="cog.png" alt="Settings" style="width: 30px; height:30px;"></button>
                <div>Sources:</div>
                <div>US Census Bureau</div>
                <div>Rhode Island Geographic Information System</div>
            </div>
        </div>
        <!-- right side of the page -->
        <div class="right">
            <div id="forMap">
            </div>
        </div>
        <!-- this is popup window for changing data info -->
        <div id="changeDataSection" class="modal">
            <div class="modal-content">
                <button onclick="document.getElementById('changeDataSection').style.display='none'" style="float:right;">X</button>
                <p style="text-align: center"><b>Changes</b></p>
                <p>Precinct's election and demographic must be loaded using the dropdown menu in order to update anything.</p>
                <label for="precinctName" style="margin-left: 180px">Name:</label>
                <input type="text" id="precinctName" name="precinctName"><br>
                <table>
                    <tr>
                        <td style="padding-right: 30px;">
                            <p><b>2016 Presidential Election:</b></p>
                            <label for="pred16Dem" style="padding-right: 10px">Democrats:</label>
                            <input type="number" id="pred16Dem" name="pred16Dem" value="0"><br><br>
                            <label for="pred16Rep">Republicans:</label>
                            <input type="number" id="pred16Rep" name="pred16Rep" value="0"><br><br>
                            <label for="pred16Other" style="padding-right: 43px">Other:</label>
                            <input type="number" id="pred16Other" name="pred16Other" value="0"><br><br>
                            <p><b>2016 Congressional Election:</b></p>
                            <label for="cong16Dem" style="padding-right: 10px">Democrats:</label>
                            <input type="number" id="cong16Dem" name="cong16Dem" value="0"><br><br>
                            <label for="cong16Rep">Republicans:</label>
                            <input type="number" id="cong16Rep" name="cong16Rep" value="0"><br><br>
                            <label for="cong16Other" style="padding-right: 43px">Other:</label>
                            <input type="number" id="cong16Other" name="cong16Other" value="0"><br><br>
                            <p><b>2018 Congressional Election:</b></p>
                            <label for="cong18Dem" style="padding-right: 10px">Democrats:</label>
                            <input type="number" id="cong18Dem" name="cong18Dem" value="0"><br><br>
                            <label for="cong18Rep">Republicans:</label>
                            <input type="number" id="cong18Rep" name="cong18Rep" value="0"><br><br>
                            <label for="cong18Other" style="padding-right: 43px">Other:</label>
                            <input type="number" id="cong18Other" name="cong18Other" value="0"><br><br>
                        </td>
                        <td>
                            <p><b>Demographic Data:</b></p>
                            <label for="whiteVotePop" style="padding-right: 20px">White:</label>
                            <input type="number" id="whiteVotePop" name="whiteVotePop" value="0"><br><br>
                            <label for="blackVotePop" style="padding-right: 20px">Black:</label>
                            <input type="number" id="blackVotePop" name="blackVotePop" value="0"><br><br>
                            <label for="asianVotePop" style="padding-right: 20px">Asian:</label>
                            <input type="number" id="asianVotePop" name="asianVotePop" value="0"><br><br>
                            <label for="hispanicVotePop">Hispanic:</label>
                            <input type="number" id="hispanicVotePop" name="hispanicVotePop" value="0"><br><br>
                            <label for="otherVotePop" style="padding-right: 20px">Other:</label>
                            <input type="number" id="otherVotePop" name="otherVotePop" value="0"><br><br>
                        </td>
                    </tr>
                </table>
                
                <center><button id="saveButton" onclick="changePrecinctData()">Save</button></center>
            </div>
        </div>
        <!-- this is popup window for changing border -->
        <div id="bordersPopup" class="modal">
            <div class="modal-content">
                <button onclick="document.getElementById('bordersPopup').style.display='none'" style="float:right;">X</button>
                <label for="precinct1">Precinct to extend:</label>
                <select id="precinct1">
                    <option value="num1">precinct</option>
                    <option>precinct1</option>
                </select>
                <br>
                <br>
                <label for="precinct2">Precinct to connect to:</label>
                <select id="precinct2">
                    <option value="num2">precinct</option>
                    <option>precinct1</option>
                </select>
                <br><br>
                <center><button>Save</button></center>
            </div>
        </div>
        <!-- shows log of what user has done -->
        <div id="errorPopup" class="modal">
            <div class="modal-content">
                <button onclick="document.getElementById('errorPopup').style.display='none'" style="float:right;">X</button>
                <h4>Error Log</h4>
                <br><br>
                <div id="errorLog"></div>
            </div>
        </div>

        <div id="settingsPopup" class="modal">
            <div class="modal-content">
                <button onclick="document.getElementById('settingsPopup').style.display='none'" style="float:right;">X</button>
                <h4>Settings</h4>
                <br>
                <div>Map View Filter</div>
                <form id="mapFilter">
                    <input type ="checkbox" id="congressionalFilter" value="congressional">
                    <label for="congressional">Congressional Data</label><br/>
                    <input type ="checkbox" id="nationalParkFilter" value="national">
                    <label for="congrenationalssional">National Park Data</label><br/>
                    <input type ="checkbox" onchange="loadFeature()" id="precinctFilter" value="precinct" checked>
                    <label for="precinct">Precincts</label>
                </form>
                <br/><br/>
                <table>
                    <tr> <td colspan="2">Election Data Color Change </td></tr>
                    <tr>
                        <td><label>Democrat: </label></td>
                        <td><input type="color" id="demColor" onchange="changeAllColor();" name="demColor" value="#0066ff"></td>
                    </tr>
                    <tr>
                        <td><label>Republican: </label></td>
                        <td><input type="color" id="repColor" onchange="changeAllColor()" name="repCcolor" value="#ff0000"></td>
                    </tr>
                    <tr>
                        <td><label>Other: </label></td>
                        <td><input type="color" id="otherColor" onchange="changeAllColor()" name="otherColor" value="#33cc33"></td>
                    </tr>
                    
                    <tr><td colspan="2"><br/>Demographic Data Color Change </td></tr>
                    <tr>
                        <td><label>White: </label></td>
                        <td><input type="color" id="whiteColor" onchange="changeAllColor()" name="whiteColor" value="#d2b58c"></td>
                    </tr>
                    <tr> 
                        <td><label>Black: </label></td>
                        <td><input type="color" id="blackColor" onchange="changeAllColor()" name="blackColor" value="#624a2e"></td>
                    </tr>
                    <tr> 
                        <td><label>Asian: </label></td>
                        <td><input type="color" id="asianColor" onchange="changeAllColor()" name="asianColor" value="#ffbf00"></td>
                    </tr>
                    <tr> 
                        <td><label>Hispanic: </label></td>
                        <td><input type="color" id="hisColor" onchange="changeAllColor()" name="hisColor" value="#6a0dad"></td>
                    </tr>
                    <tr> 
                        <td><label>Other: </label></td>
                        <td><input type="color" id="restColor" onchange="changeAllColor()" name="restColor" value="#8affff"></td>
                    </tr>
                </table>
            </div>
        </div>
    </body>
    <script>
        function findPrecincts(){
            let searchResult=document.getElementById("precinctSearch").value;
            
            let searchRequest=new XMLHttpRequest();
            searchRequest.open('GET','http://localhost:8080/precincts/names/'+searchResult);
            searchRequest.onload=()=> {
                let searchData=JSON.parse(searchRequest.response);
                document.getElementById("searchResults").innerHTML="";
                for(let i=0;i<searchData.length;i++){
                    let newOption=document.createElement("button");
                    let name=searchData[i];
                    console.log(name);
                    newOption.onclick=()=>{
                        precMenuChange(name);
                        document.getElementById("precinctSearch").value="";
                        document.getElementById("searchResults").innerHTML="";
                    }
                    newOption.innerHTML=name;
                    document.getElementById("searchResults").append(newOption);
                }
            }
            searchRequest.send();
        }
        
        function openChangeDataSection(){
            let selectedPrecinct=document.getElementById("selectedPrecinct").innerHTML;
            document.getElementById('precinctName').value = selectedPrecinct;
            if(selectedPrecinct!=""){
                document.getElementById('changeDataSection').style.display='block';
                
                let selectedLayer=precincts[selectedPrecinct];
                let selectedFeature=selectedLayer.feature;
                if(selectedFeature.properties.demographic!=undefined && selectedFeature.properties.election!=undefined){
                    document.getElementById("saveButton").disabled=false;
                }
                else{
                    document.getElementById("saveButton").disabled=true;
                }
            }
            
        }
        function populateElectionData(selectedFeature){
            document.getElementById("pred16Dem").value=selectedFeature.properties.election.demvotpres;
            document.getElementById("pred16Rep").value=selectedFeature.properties.election.repvotpres;
            document.getElementById("pred16Other").value=selectedFeature.properties.election.othvotpres;
            document.getElementById("cong16Dem").value=selectedFeature.properties.election.demvot16;
            document.getElementById("cong16Rep").value=selectedFeature.properties.election.repvot16;
            document.getElementById("cong16Other").value=selectedFeature.properties.election.othvot16;
            document.getElementById("cong18Dem").value=selectedFeature.properties.election.demvot18;
            document.getElementById("cong18Rep").value=selectedFeature.properties.election.repvot18;
            document.getElementById("cong18Other").value=selectedFeature.properties.election.othvot18;
        }
        function populateDemographicData(selectedFeature){
            document.getElementById("whiteVotePop").value=Math.floor(selectedFeature.properties.demographic.whiteov18);
            document.getElementById("blackVotePop").value=Math.floor(selectedFeature.properties.demographic.blackov18);
            document.getElementById("asianVotePop").value=Math.floor(selectedFeature.properties.demographic.asianov18);
            document.getElementById("hispanicVotePop").value=Math.floor(selectedFeature.properties.demographic.hisov18);
            document.getElementById("otherVotePop").value=Math.floor(selectedFeature.properties.demographic.otherov18);
        }
        function switchDataSection(){
            if(document.getElementById("dataSection").value == "election"){
                document.getElementById("electionDropdownArea").style.display="";
                document.getElementById('electionSection').style.display = "block";
                document.getElementById('demographicSection').style.display = "none";
                setElectionSection();
            }
            if(document.getElementById("dataSection").value == "demographic"){
                document.getElementById("electionDropdownArea").style.display="none";
                document.getElementById('electionSection').style.display = "none";
                document.getElementById('demographicSection').style.display = "block";
                setDemographicSection();
            }
            if(document.getElementById("dataSection").value == "none"){
                document.getElementById("electionDropdownArea").style.display="none";
                document.getElementById('electionSection').style.display = "none";
                document.getElementById('demographicSection').style.display = "none";
            }
        }
        function zoomOut(){
            let usaCoords=[39.436192999314095,-98.26171875];
            let usaZoomLevel=4;
            mymap.setView(new L.LatLng(usaCoords[0],usaCoords[1]), usaZoomLevel);
        }
        function initLoad(){
            //L is an object that represents the library and its functions that are available.
            mymap = L.map('forMap');
            zoomOut();
            L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors,\n\
                        <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox/streets-v11',
            accessToken: 'pk.eyJ1IjoiZTE1MzEwODgiLCJhIjoiY2s3NzdjOWl3MDRzdTNmcWtqdDNlamxhNiJ9.aN5tSOOA7nNJA0KCnOITBA'}).addTo(mymap);
            precinctLayer=L.geoJSON(null,{onEachFeature: onEachPrecinct}).addTo(mymap);
            stateLayer=L.geoJSON(null,{onEachFeature: onEachState}).addTo(mymap);
            loadFeature();
        }
        function loadFeature(){
            let statesMenu = document.getElementById("States");
            let stateName=statesMenu.value;
            //0 is rhodeisland,1 is north carolina, 2 is arizona
            let stateCoords=[[41.5801,-71.4774]];
            let zoomLevel=[10];
            unloadAll();
            let precinctFilter=document.getElementById("precinctFilter").checked;
            switch(stateName){
                case "Rhode Island":
                    let stateFP=states[stateName].properties.statefp;
                    mymap.setView(new L.LatLng(stateCoords[0][0],stateCoords[0][1]), zoomLevel);
                    if(precinctFilter) loadPrecinctsForState(stateFP);
                    break;
                default:
                    stateLayer.clearLayers();
                    document.getElementById("searchWindow").style.display="none";
                    statesMenu.innerHTML="<option value='State'>State</option>";
                    loadStatesForMap(stateName);
                    zoomOut();
                    break;
            }
        }
        function unloadAll(){
            precinctLayer.clearLayers();
            precincts={};
            errors={};
            clearBothSections();
            document.getElementById("selectedPrecinct").innerHTML=="";
            document.getElementById("errorLog").innerHTML="";
            document.getElementById("searchWindow").style.display="inline";
        }
        function loadErrorsForState(stateFP){
            let errorsRequest=new XMLHttpRequest();
            errorsRequest.open('GET','http://localhost:8080/errors/'+stateFP);
            errorsRequest.onload=()=> {
                let errorData=JSON.parse(errorsRequest.response);
                loadErrorDictionary(errorData);
            }
            errorsRequest.send();
        }
        function loadErrorDictionary(errorData){
            errors={};
            for(i=0;i<errorData.length;i++){
                errors[errorData[i].precinctID]=errorData[i].errorType;
            }
        }
        function loadStatesForMap(stateName){
            states={};
            let statesRequest=new XMLHttpRequest();
            statesRequest.open('GET','http://localhost:8080/states');
            statesRequest.onload=()=>{
                let statesData=JSON.parse(statesRequest.response);
                for(i=0;i<statesData.length;i++){
                    let state=prepareStateToUse(statesData[i]);
                    stateLayer.addData(state);
                    states[state.properties.name]=state;
                }
                loadStateNames();
            };
            statesRequest.send();
        }
        function loadStateNames(){
            let statesMenu = document.getElementById("States");
            let eachLayer=(singleLayer)=>{
                let feature=singleLayer.feature;
                let addedState = document.createElement("option");
                addedState.text = feature.properties.name;
                addedState.value = feature.properties.name;
                statesMenu.options.add(addedState);
            }
            stateLayer.eachLayer(eachLayer);
        }
        function loadPrecinctsForState(stateFP){
            let precinctsRequest=new XMLHttpRequest();
            precinctsRequest.open('GET','http://localhost:8080/precincts/'+stateFP);
            precinctsRequest.onload=()=> {
                let precinctsData=JSON.parse(precinctsRequest.response);
                for(i=0;i<precinctsData.length;i++){
                    precinctLayer.addData(preparePrecinctToUse(precinctsData[i]));
                }
                loadPrecinctDictionary();
            }
            precinctsRequest.send();
        }
        function loadDemographicForPrecinct(precinctFeature){
            let demographicRequest=new XMLHttpRequest();
            demographicRequest.open('GET','http://localhost:8080/precincts/demographic/'+precinctFeature.properties.ogrFID);
            demographicRequest.onload=()=>{
                precinctFeature.properties.demographic=JSON.parse(demographicRequest.response);
                setDemographicSection();
                populateDemographicData(precinctFeature);
            }
            demographicRequest.send();
        }
        function loadElectionForPrecinct(precinctFeature){
            let electionRequest=new XMLHttpRequest();
            electionRequest.open('GET','http://localhost:8080/precincts/election/'+precinctFeature.properties.ogrFID);
            electionRequest.onload=()=>{
                precinctFeature.properties.election=JSON.parse(electionRequest.response);
                setElectionSection();
                populateElectionData(precinctFeature);
            }
            electionRequest.send();
        }
        function prepareStateToUse(state){
            let stateShape=JSON.parse(state["state_geojson"]);
            let newState={};
            newState["type"]="Feature";
            newState["properties"]={};
            newState.properties["statefp"]=state["statefp"];
            newState.properties["name"]=state["name"];
            newState.properties["ogrFID"]=state["ogrFID"];
            newState["geometry"]={};
            newState.geometry["type"]=stateShape["type"];
            newState.geometry["coordinates"]=stateShape["coordinates"];
            return newState;
        }
        function preparePrecinctToUse(precinct){
            let precinctShape=JSON.parse(precinct["shape_geojson"]);
            let newPrecinct={};
            newPrecinct["type"]="Feature";
            newPrecinct["properties"]={};
            newPrecinct.properties["ogrFID"]=precinct["ogrFID"];
            newPrecinct.properties["name"]=precinct["name"]
            newPrecinct.properties["statefp"]=precinct["statefp"]
            newPrecinct["geometry"]={};
            newPrecinct.geometry["type"]=precinctShape["type"];
            newPrecinct.geometry["coordinates"]=precinctShape["coordinates"];
            return newPrecinct;
        }
        function loadPrecinctDictionary(){
            precincts={};
            let eachLayer=(singleLayer)=>{
                let feature=singleLayer.feature;
                precincts[feature.properties.name]=singleLayer;
            }
            precinctLayer.eachLayer(eachLayer);
        }
        function setShapeColor(feature,shapeStyle){
            switch(shapeStyle){
                case "STATE_STYLE": 
                    return{
                        weight:4,
                        color:'black'
                    };
                case "NEW_PREC_STYLE":
                    return{
                        fillOpacity: 0.8
                    };
                case "OLD_PREC_STYLE":
                    return{
                        fillOpacity: 0.2,
                        weight:1
                    };
                case "DEFAULT_STYLE":
                    return{
                        color:'black',
                        fillColor:'#C0C0C0',
                        weight:2
                    }
                case "DEM_STYLE":
                    return{
                        color:document.getElementById("demColor").value
                    };
                case "REP_STYLE":
                    return{
                        color:document.getElementById("repColor").value
                    };
                case "OTHER_ELECTION_STYLE":
                    return{
                        color:document.getElementById("otherColor").value
                    };
                case "OTHER_DEMO_STYLE":
                    return{
                        color:document.getElementById("restColor").value
                    };
                case "WHITE_STYLE":
                    return{
                        color:document.getElementById("whiteColor").value
                    };
                case "BLACK_STYLE":
                    return{
                        color:document.getElementById("blackColor").value
                    };
                case "ASIAN_STYLE":
                    return{
                        color:document.getElementById("asianColor").value
                    };
                case "HIS_STYLE":
                    return{
                        color:document.getElementById("hisColor").value
                    };
                case "GHOST_STYLE":
                    return{
                        color:'gray'
                    };
                case "ERROR_STYLE":
                    return{
                        color:'orange'
                    }
                default:
                    console.log(feature);
                    console.log("un-intended");
            }
        }
        function setNPS(e){
            this.setStyle(setShapeColor(this,"NEW_PREC_STYLE"));
        }
        function setOPS(e){
            this.setStyle(setShapeColor(this,"OLD_PREC_STYLE"));
        }
        function precinctZoom(precinctCenter,precinctSize){
            //console.log(precinctSize);
            let precinctZoomLevel=10.5;
            if(precinctSize<99999999) precinctZoomLevel=11;
            if(precinctSize<59999999) precinctZoomLevel=11.5;
            if(precinctSize<9999999) precinctZoomLevel=12;
            if(precinctSize<5999999) precinctZoomLevel=12.5;
            if(precinctSize<999999) precinctZoomLevel=13;
            if(precinctSize<599999) precinctZoomLevel=13.5;
            //console.log(precinctZoomLevel);
            let centerCoords=precinctCenter.geometry.coordinates;
            //resets center
            mymap.setView(new L.LatLng(0,0),precinctZoomLevel);
            mymap.setView(new L.LatLng(centerCoords[1],centerCoords[0]),precinctZoomLevel);
        }
        function setDemographicSection(){
            let selectedPrecinct=document.getElementById("selectedPrecinct").innerHTML;
            if(selectedPrecinct=="") return;
            let selectedLayer=precincts[selectedPrecinct];
            let selectedFeature=selectedLayer.feature;
            let selectedDemographic=document.getElementById("dataSection").value;
            if(selectedDemographic!="demographic") return;
            if(selectedFeature.properties.demographic==undefined){
                loadDemographicForPrecinct(selectedFeature);
                return;
            }
            
            let whiteVotePop=selectedFeature.properties.demographic.whiteov18;
            let blackVotePop=selectedFeature.properties.demographic.blackov18;
            let asianVotePop=selectedFeature.properties.demographic.asianov18;
            let hispanicVotePop=selectedFeature.properties.demographic.hisov18;
            let otherVotePop=selectedFeature.properties.demographic.otherov18;
            let totVotePop=selectedFeature.properties.demographic.pop100;

            document.getElementById("whiteNum").innerHTML=Math.floor(whiteVotePop);
            document.getElementById("blackNum").innerHTML=Math.floor(blackVotePop);
            document.getElementById("asianNum").innerHTML=Math.floor(asianVotePop);
            document.getElementById("hispanicNum").innerHTML=Math.floor(hispanicVotePop);
            document.getElementById("otherNum").innerHTML=Math.floor(otherVotePop);
            document.getElementById("totVotePop").innerHTML=Math.floor(totVotePop);
            changeAllColor();
        }
        function setElectionSection(){
            let selectedPrecinct=document.getElementById("selectedPrecinct").innerHTML;
            if(selectedPrecinct=="") return;
            let selectedLayer=precincts[selectedPrecinct];
            let selectedFeature=selectedLayer.feature;
            let selectedElection=document.getElementById("dataSection").value;
            if(selectedElection!="election") return;
            if(selectedFeature.properties.election==undefined){
                loadElectionForPrecinct(selectedFeature);
                return;
            }
            selectedElection = document.getElementById("year").value;
            if(selectedElection=="none") return;
            
            let pred16D=selectedFeature.properties.election.demvotpres;
            let pred16R=selectedFeature.properties.election.repvotpres;
            let pred16O=selectedFeature.properties.election.othvotpres;
            let cong16D=selectedFeature.properties.election.demvot16;
            let cong16R=selectedFeature.properties.election.repvot16;
            let cong16O=selectedFeature.properties.election.othvot16;
            let cong18D=selectedFeature.properties.election.demvot18;
            let cong18R=selectedFeature.properties.election.repvot18;
            let cong18O=selectedFeature.properties.election.othvot18;
            let pred16T=selectedFeature.properties.election.totvotpres;
            let cong16T=selectedFeature.properties.election.totvot16;
            let cong18T=selectedFeature.properties.election.totvot18;
            if(selectedElection == "pred16"){
                document.getElementById("totVotePop").innerHTML=pred16T + " people";
                if(pred16T==0)document.getElementById("demNum").innerHTML = 0 + " people [0%]";
                else document.getElementById("demNum").innerHTML = pred16D+ " people ["+Math.round(100*(pred16D/pred16T)) +"%]";
                if(pred16T==0) document.getElementById("repNum").innerHTML = 0 + " people [0%]";
                else document.getElementById("repNum").innerHTML = pred16R+ " people ["+Math.round(100*(pred16R/pred16T)) +"%]";
                if(pred16O==0) document.getElementById("othNum").innerHTML = 0 + " people [0%]";
                else document.getElementById("othNum").innerHTML = pred16O+ " people ["+Math.round(100*(pred16O/pred16T)) +"%]";
            }
            else if(selectedElection == "cong16"){
                document.getElementById("demNum").innerHTML = cong16D;
                document.getElementById("repNum").innerHTML = cong16R;
                document.getElementById("totVotePop").innerHTML=cong16T + " people";
                document.getElementById("othNum").innerHTML = cong16O;
            }
            else if(selectedElection == "cong18"){
                document.getElementById("demNum").innerHTML = cong18D;
                document.getElementById("repNum").innerHTML = cong18R;
                document.getElementById("othNum").innerHTML = cong18O;
                document.getElementById("totVotePop").innerHTML=cong18T + " people";
            }
            changeAllColor();
        }
        function clearBothSections(){
            document.getElementById("whiteNum").innerHTML="N/A";
            document.getElementById("blackNum").innerHTML="N/A";
            document.getElementById("asianNum").innerHTML="N/A";
            document.getElementById("hispanicNum").innerHTML="N/A";
            document.getElementById("otherNum").innerHTML="N/A";
            document.getElementById("totVotePop").innerHTML="N/A";
            document.getElementById("demNum").innerHTML ="N/A";
            document.getElementById("repNum").innerHTML ="N/A";
            document.getElementById("othNum").innerHTML ="N/A";
        }
        function precMenuChange(selectedValue){
            let selectedLayer=precincts[selectedValue];
            let selectedFeature=selectedLayer.feature;
            showPrecinctOnClick(selectedLayer,selectedFeature);
        }
        function showPrecinctOnClick(selectedLayer,selectedFeature){
            precinctZoom(turf.centroid(selectedFeature),turf.area(selectedFeature));
            precinctLayer.setStyle(setShapeColor(precinctLayer,"OLD_PREC_STYLE"));
            selectedLayer.setStyle(setShapeColor(selectedLayer,"NEW_PREC_STYLE"));
            setDemographicSection(selectedFeature);
            setElectionSection(selectedFeature);
            showError(selectedLayer,selectedFeature.properties.errorType);
        }
        function changeAllColor(){
            for(i in precincts){
                let singleLayer=precincts[i];
                let feature=singleLayer.feature;
                changeFeatColor(feature,singleLayer);
            }
        }
        function changeFeatColor(selectedFeature,selectedLayer){
            let properties=selectedFeature.properties;
            if(properties.demographic==undefined && properties.error==undefined && properties.election==undefined){
                selectedLayer.setStyle(setShapeColor(selectedLayer,"DEFAULT_STYLE"));
                return;
            }
            if(selectedFeature.properties.error!=undefined && selectedFeature.properties.error.errorType!="NONE" && selectedFeature.properties.error.errorType!="RESOLVED"){
                selectedLayer.setStyle(setShapeColor(selectedLayer,"ERROR_STYLE"));
            }
            else{
                let dataType=document.getElementById("dataSection").value;
                switch (dataType){
                    case "demographic":
                        let whiteov18=properties.demographic.whiteov18;
                        let blackov18=properties.demographic.blackov18;
                        let asianov18=properties.demographic.asianov18;
                        let hisov18=properties.demographic.hisov18;
                        let otherov18=properties.demographic.otherov18;
                        let majorityRace=Math.max(whiteov18,blackov18,asianov18,hisov18,otherov18);
                        switch(majorityRace){
                            case 0: {selectedLayer.setStyle(setShapeColor(selectedLayer,"GHOST_STYLE")); break;}
                            case whiteov18: {selectedLayer.setStyle(setShapeColor(selectedLayer,"WHITE_STYLE")); break;}
                            case blackov18: {selectedLayer.setStyle(setShapeColor(selectedLayer,"BLACK_STYLE")); break;}
                            case asianov18: {selectedLayer.setStyle(setShapeColor(selectedLayer,"ASIAN_STYLE")); break;}
                            case hisov18: {selectedLayer.setStyle(setShapeColor(selectedLayer,"HIS_STYLE")); break;}
                            case otherov18: {selectedLayer.setStyle(setShapeColor(selectedLayer,"OTHER_DEMO_STYLE")); break;}
                        }
                        break;
                    case "election":
                        let majorityParty=0;
                        let electionValue=document.getElementById("year").value;
                        switch(electionValue){
                            case "pred16":
                                let demvotpres=properties.election.demvotpres;
                                let repvotpres=properties.election.repvotpres;
                                let othvotpres=properties.election.othvotpres;
                                majorityParty=Math.max(demvotpres,repvotpres,othvotpres);
                                switch(majorityParty){
                                    case 0: {selectedLayer.setStyle(setShapeColor(selectedLayer,"GHOST_STYLE")); break;}
                                    case demvotpres: {selectedLayer.setStyle(setShapeColor(selectedLayer,"DEM_STYLE")); break;}
                                    case repvotpres: {selectedLayer.setStyle(setShapeColor(selectedLayer,"REP_STYLE")); break;}
                                    case othvotpres: {selectedLayer.setStyle(setShapeColor(selectedLayer,"OTHER_ELECTION_STYLE")); break;}
                                }
                                break;
                            case "cong16":
                                let demvot16=properties.election.demvot16;
                                let repvot16=properties.election.repvot16;
                                let othvot16=properties.election.othvot16;
                                majorityParty=Math.max(demvot16,repvot16,othvot16);
                                switch(majorityParty){
                                    case 0: {selectedLayer.setStyle(setShapeColor(selectedLayer,"GHOST_STYLE")); break;}
                                    case demvot16: {selectedLayer.setStyle(setShapeColor(selectedLayer,"DEM_STYLE")); break;}
                                    case repvot16: {selectedLayer.setStyle(setShapeColor(selectedLayer,"REP_STYLE")); break;}
                                    case othvot16: {selectedLayer.setStyle(setShapeColor(selectedLayer,"OTHER_ELECTION_STYLE")); break;}
                                }
                                break;
                            case "cong18":
                                let demvot18=properties.election.demvot18;
                                let repvot18=properties.election.repvot18;
                                let othvot18=properties.election.othvot18;
                                majorityParty=Math.max(demvot18,repvot18,othvot18);
                                switch(majorityParty){
                                    case 0: {selectedLayer.setStyle(setShapeColor(selectedLayer,"GHOST_STYLE")); break;}
                                    case demvot18: {selectedLayer.setStyle(setShapeColor(selectedLayer,"DEM_STYLE")); break;}
                                    case repvot18: {selectedLayer.setStyle(setShapeColor(selectedLayer,"REP_STYLE")); break;}
                                    case othvot18: {selectedLayer.setStyle(setShapeColor(selectedLayer,"OTHER_ELECTION_STYLE")); break;}
                                }
                                break;
                        }
                }
            }
        }
        function onClick(e){
            let selectedName=e.target.feature.properties.name;
            document.getElementById("selectedPrecinct").innerHTML=selectedName;
            precMenuChange(selectedName);
        }
        function prepareErrorToSend(feature){
            let today = new Date();
            let dateTime = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate()+" "+today.getHours() + ":" + today.getMinutes()+":"+today.getSeconds();
            let comment="["+dateTime+"] >>"+document.getElementById("commentArea").value+"<br/>";
            let preparedError={};
            preparedError["comment"]=document.getElementById("commentArea").value;
            document.getElementById("errorLog").innerHTML+="<div style=\'border-style:solid\'>Error Resolved on: "+feature.properties.name+" from ERROR: "+feature.properties.errorType+". <br/> Optional Comment: "+comment+"</div><br/>";
            preparedError["errorType"]="RESOLVED";
            feature.properties.errorType="RESOLVED";
            document.getElementById("commentArea").value="";
            return preparedError;
        }
        function updateError(id,newError){
            let errorRequest=new XMLHttpRequest();
            errorRequest.open('PUT','http://localhost:8080/errors/'+id);
            if(newError){
                errorRequest.setRequestHeader('Content-Type','application/json');
            }
            newError=JSON.stringify(newError);
            errorRequest.send(newError);
        }
        function setGhostPrecinct(layer){
            let feature=layer.feature;
            let featureID=feature.properties.ogrFID;
            let buttonToBeDeleted=document.getElementById(feature.properties.name+"_error");
            buttonToBeDeleted.parentNode.removeChild(buttonToBeDeleted);
            let errorDiv=document.getElementById("currentError");
            layer.setStyle(setShapeColor(layer,"GHOST_STYLE"));
            errorDiv.innerHTML="";
            document.getElementById("errorSection").style.display="none";
            updatePrecinct(featureID,preparePrecinctToSend(feature));
            updateError(featureID,prepareErrorToSend(feature));
        }
        function updatePrecinct(selectedID,newPrecinct){
            let precinctRequest=new XMLHttpRequest();
            precinctRequest.open('PUT','http://localhost:8080/precincts/'+selectedID);
            if(newPrecinct){
                precinctRequest.setRequestHeader('Content-Type','application/json');
            }
            let precinct=JSON.stringify(newPrecinct);
            console.log(precinct);
            precinctRequest.send(precinct);
        }
        function preparePrecinctToSend(feature){
            let preparedPrecinct={};
            preparedPrecinct["ogrFID"]=feature.properties.ogrFID;
            preparedPrecinct["name"]=feature.properties.name;
            preparedPrecinct["statefp"]=feature.properties.statefp;
            preparedPrecinct["error"]=feature.properties.error;
            preparedPrecinct["demographic"]=feature.properties.demographic;
            preparedPrecinct["election"]=feature.properties.election;
            preparedPrecinct["shape_geojson"]=JSON.stringify(feature.geometry);
            return preparedPrecinct;
        }
        function mergePrecincts(layer){
            let feature=layer.feature;
            let buttonToBeDeleted=document.getElementById(feature.properties.name+"_error");
            buttonToBeDeleted.parentNode.removeChild(buttonToBeDeleted);
            let errorDiv=document.getElementById("currentError");
            errorDiv.innerHTML="";
            document.getElementById("errorSection").style.display="none";
            
            console.log(feature);
            let newPrecinct={"type":"Feature",
                "properties":feature.properties,
                "geometry":{
                    "type":"Polygon",
                    "coordinates":[feature.geometry.coordinates[0][0]]
                }
            };
            layer.remove();
            precinctLayer.removeLayer(layer);
            precinctLayer.addData(newPrecinct);
            
            updatePrecinct(feature.properties.ogrFID,newPrecinct);
            updateError(feature.properties.ogrFID,prepareErrorToSend(newPrecinct));
        }
        function showError(layer,errorType){
            let featureName=layer.feature.properties.name;
            let errorDiv=document.getElementById("currentError");
            switch(errorType){
                case "GHOST":
                    document.getElementById("errorSection").style.display="block";
                    errorDiv.innerHTML="Ghost Precinct? <br>\n\
                        <button onclick='setGhostPrecinct(precincts[\""+featureName+"\"])'>Yes</button>\n\
                        <button onclick='openChangeDataSection();'>No</button>";
                    break;
                case "DONUT":
                    document.getElementById("errorSection").style.display="block";
                    errorDiv.innerHTML="Merge Precinct<br>\n\
                        <button onclick='mergePrecincts(precincts[\""+featureName+"\"])'>Yes</button>";
                    break;
                default:
                    document.getElementById("errorSection").style.display="none";
                    errorDiv.innerHTML="";
            }
        }
        function changePrecinctData(){
            let pred16Dem=document.getElementById("pred16Dem").value;
            let pred16Rep=document.getElementById("pred16Rep").value;
            let pred16Oth=document.getElementById("pred16Other").value;
            let cong16Dem=document.getElementById("cong16Dem").value;
            let cong16Rep=document.getElementById("cong16Rep").value;
            let cong16Oth=document.getElementById("cong16Other").value;
            let cong18Dem=document.getElementById("cong18Dem").value;
            let cong18Rep=document.getElementById("cong18Rep").value;
            let cong18Oth=document.getElementById("cong18Other").value;
            let whiteVotePop=document.getElementById("whiteVotePop").value;
            let blackVotePop=document.getElementById("blackVotePop").value;
            let asianVotePop=document.getElementById("asianVotePop").value;
            let hispanicVotePop=document.getElementById("hispanicVotePop").value;
            let otherVotePop=document.getElementById("otherVotePop").value;
            
            let selectedValue=document.getElementById("selectedPrecinct").innerHTML;
            let selectedLayer=precincts[selectedValue];
            let selectedFeature=selectedLayer.feature;
            let selectedID=selectedFeature.properties.ogrFID;
            changePrecinctVotingData(selectedFeature,pred16Dem,pred16Rep,pred16Oth,cong16Dem,cong16Rep,cong16Oth,cong18Dem,cong18Rep,cong18Oth);
            changePrecinctDemographicData(selectedFeature,whiteVotePop,blackVotePop,asianVotePop,hispanicVotePop,otherVotePop);
            
            //changes the name of the feature, removes the name off the dropdown, and adds the new name in
            if(selectedValue!=document.getElementById("precinctName").value){
                selectedFeature.properties.name=document.getElementById("precinctName").value;
                precincts[selectedFeature.properties.name]=precincts[selectedValue];
                delete precincts[selectedValue];
                document.getElementById("selectedPrecinct").innerHTML=selectedFeature.properties.name;
                console.log(selectedFeature);
            }
            showPrecinctOnClick(selectedLayer,selectedFeature);
            
            if(selectedFeature.properties.errorType=="GHOST" && document.getElementById("pred16Dem").value!=0){
                let selectedError=document.getElementById(selectedValue+"_error");
                if(selectedError!=undefined){
                    selectedError.parentNode.removeChild(selectedError);
                    document.getElementById("currentError").innerHTML="";
                    document.getElementById("errorSection").style.display="none";
                }
                updateError(selectedFeature.properties.ogrFID,prepareErrorToSend(selectedFeature));
            }
            document.getElementById('changeDataSection').style.display='none';
            changeFeatColor(selectedLayer.feature,selectedLayer);
            updatePrecinct(selectedID,preparePrecinctToSend(selectedFeature));
        }
	function changePrecinctDemographicData(feature,whiteVotePop,blackVotePop,asianVotePop,hispanicVotePop,otherVotePop){
            feature.properties.demographic.whiteov18=parseInt(whiteVotePop);
            feature.properties.demographic.blackov18=parseInt(blackVotePop);
            feature.properties.demographic.asianov18=parseInt(asianVotePop);
            feature.properties.demographic.hisov18=parseInt(hispanicVotePop);
            feature.properties.demographic.otherov18=parseInt(otherVotePop);
	}
        function changePrecinctVotingData(feature,pred16Dem,pred16Rep,pred16Oth,cong16Dem,cong16Rep,cong16Oth,cong18Dem,cong18Rep,cong18Oth){
            feature.properties.election.demvotpres=parseInt(pred16Dem);
            feature.properties.election.repvotpres=parseInt(pred16Rep);
            feature.properties.election.othvotpres=parseInt(pred16Oth);
            feature.properties.election.demvot16=parseInt(cong16Dem);
            feature.properties.election.repvot16=parseInt(cong16Rep);
            feature.properties.election.othvot16=parseInt(cong16Oth);
            feature.properties.election.demvot18=parseInt(cong18Dem);
            feature.properties.election.repvot18=parseInt(cong18Rep);
            feature.properties.election.othvot18=parseInt(cong18Oth);
        }
        function onEachPrecinct(feature,layer){
            layer.on({
                click: onClick
            });
            if(feature.properties.errorType=="GHOST"){
               document.getElementById("errorLog").innerHTML+="<div id=\""+feature.properties.name+"_error\"><button onclick='document.getElementById(\"errorPopup\").style.display=\"none\";precMenuChange(\""+feature.properties.name+"\");'>Ghost Precinct Found ["+feature.properties.name+"](Requires Verification)</button></div>";
            }
            if(feature.properties.name=="Burrillville 0302" && feature.geometry.type=="MultiPolygon"){
               document.getElementById("errorLog").innerHTML+="<div id=\""+feature.properties.name+"_error\"><button onclick='document.getElementById(\"errorPopup\").style.display=\"none\";precMenuChange(\""+feature.properties.name+"\");'>Donut Precinct Found ["+feature.properties.name
                       +"](Requires Modification)</button></div>";
            }
            changeFeatColor(feature,layer);
        }
        function onEachState(feature,layer){
            layer.on({
                click:loadFeature
            });
            layer.setStyle(setShapeColor(layer,"STATE_STYLE"));
        }
    </script>
</html>
