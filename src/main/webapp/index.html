<!DOCTYPE html>
<!--
Author: Wen Lin
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>State Election and Demographic Data</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="newcss.css">
        <script src='https://unpkg.com/@turf/turf/turf.min.js'></script>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
              integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="crossorigin=""/>
        <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
        <script language="javascript" type="text/javascript" src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
                integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="crossorigin="">
        </script>
    </head>
    <body>
        <div class="split left">
            <div class="centered">
                <h3>Information</h3>
                <div style="padding-bottom:10px">
                    <label for="States" style="font-size: 20px;padding-right: 26px">State:</label>
                    <select id="States"> <!-- needs to be replaced by data from DB -->
                        <option value="State" onclick="loadFeature()">State</option>
                        <option value ="Arizona" onclick="loadFeature(this.value)">Arizona</option>
                        <option value="Rhode Island" onclick="loadFeature(this.value)">Rhode Island</option>
                        <option value="North Carolina" onclick="loadFeature(this.value)">North Carolina</option>
                    </select>
                </div>
                <div id="precinctDropdown" style="display:none" >
                    <label for="Precincts" style="font-size: 20px;">Precinct:</label>
                    <select id="Precincts" onchange="precMenuChange()" style="width: 120px"> <!-- needs to be replaced by DB data -->
                        <option value="precinct">Precinct</option>
                    </select>
                    <br>
                </div>
                
                <h4>Population:</h4>
                <label id="totVotePop"> X people</label>
                <table cellpadding="0">
                    <tr>
                        <td><label for="dataSection">Data Type:</label></td>
                        <td>
                            <select id="dataSection" onchange="switchDataSection()" style="">
                                <option value="election">Election</option>
                                <option value="demographic">Demographic</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="year">Election Type:</label></td>
                        <td>
                            <select id="year" onchange="setElectionSection()" style="">
                                <option id="pred16" value="pred16">Presidential 2016</option>
                                <option id="cong16" value="cong16">Congressional 2016</option>
                                <option id="cong18" value="cong18">Congressional 2018</option>
                            </select>
                        </td>
                    </tr>
                </table>
                <br><br>
                <div id="electionSection">
                    <label>Democratic: </label><label id="demNum">X people [X%]</label><br/> <!-- needs to be replaced by DB data -->
                    <label>Republican: </label><label id="repNum">Y people [Y%]</label><br/> <!-- needs to be replaced by DB data -->
                    <label style="padding-right: 43px">Other:</label><label id="othNum">Z people [Z%]</label><br/> <!-- needs to be replaced by DB data -->
                    <br>
                </div>
                <div id="demographicSection">
                    <label>White: </label><label id="whiteNum" style="padding-left: 20px">X people</label><br/> <!-- needs to be replaced by DB data -->
                    <label>Black: </label><label id="blackNum" style="padding-left: 20px">Y people</label><br/> <!-- needs to be replaced by DB data -->
                    <label>Asian: </label><label id="asianNum" style="padding-left: 20px">Y people</label><br/> <!-- needs to be replaced by DB data -->
                    <label>Hispanic: </label><label id="hispanicNum">Y people</label><br/> <!-- needs to be replaced by DB data -->
                    <label>Other: </label><label id="otherNum" style="padding-left: 20px">Y people</label><br/> <!-- needs to be replaced by DB data -->
                </div>
                <div id="errorSection" style="display:none">
                    <h3>Error Type:</h3>
                    <div id="currentError"></div>
                    <br>
                    <label for="commentArea">Comments:</label><br>
                    <textarea placeholder="Type your comment for the resolved error" id="commentArea" name="commentArea" rows="2" cols="20"></textarea>
                </div>
                <p>Options:</p>
                <div id="optionSection">
                    <button onclick="openChangeDataSection()" style="width:auto;margin-right: 25px">Change Data</button>
                    <button onclick="document.getElementById('bordersPopup').style.display='block'" style="width:auto;">Fix Borders</button>
                    <br>
                </div>
                <br>
                <br>
                <button onclick="document.getElementById('errorPopup').style.display='block'" style="width:50px;height: 40px;"><img src="ee.png" alt="Error Log" style="width: 30px;height: 30px;"></button>
                <button onclick="document.getElementById('settingsPopup').style.display='block'" style="width:50px; height:40px"><img src="cog.png" alt="Settings" style="width: 30px; height:30px;"></button>
                <div>Sources:</div>
                <a href="https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/UBKYRU" style="text-decoration: none" target="_blank">Harvard Dataverse</a><br/>
                <a href="https://catalog.data.gov/dataset/tiger-line-shapefile-2017-nation-u-s-current-state-and-equivalent-national" style="text-decoration: none"  target="_blank">US Census Bureau</a>
            </div>
        </div>
        <!-- right side of the page -->
        <div class="right">
            <div id="forMap">
            </div>
        </div>
        <!-- this is popup window for changing data info -->
        <div id="changeDataSection" class="modal">
            <div class="modal-content">
                <button onclick="document.getElementById('changeDataSection').style.display='none'" style="float:right;">X</button>
                <p style="text-align: center"><b>Changes</b></p>
                <label for="precinctName" style="margin-left: 180px">Name:</label>
                <input type="text" id="precinctName" name="precinctName"><br>
                <table>
                    <tr>
                        <td style="padding-right: 30px;">
                            <p><b>2016 Presidential Election:</b></p>
                            <label for="pred16Dem" style="padding-right: 10px">Democrats:</label>
                            <input type="number" id="pred16Dem" name="pred16Dem" value="0"><br><br>
                            <label for="pred16Rep">Republicans:</label>
                            <input type="number" id="pred16Rep" name="pred16Rep" value="0"><br><br>
                            <label for="pred16Other" style="padding-right: 43px">Other:</label>
                            <input type="number" id="pred16Other" name="pred16Other" value="0"><br><br>
                            <p><b>2016 Congressional Election:</b></p>
                            <label for="cong16Dem" style="padding-right: 10px">Democrats:</label>
                            <input type="number" id="cong16Dem" name="cong16Dem" value="0"><br><br>
                            <label for="cong16Rep">Republicans:</label>
                            <input type="number" id="cong16Rep" name="cong16Rep" value="0"><br><br>
                            <label for="cong16Other" style="padding-right: 43px">Other:</label>
                            <input type="number" id="cong16Other" name="cong16Other" value="0"><br><br>
                            <p><b>2018 Congressional Election:</b></p>
                            <label for="cong18Dem" style="padding-right: 10px">Democrats:</label>
                            <input type="number" id="cong18Dem" name="cong18Dem" value="0"><br><br>
                            <label for="cong18Rep">Republicans:</label>
                            <input type="number" id="cong18Rep" name="cong18Rep" value="0"><br><br>
                            <label for="cong18Oth" style="padding-right: 43px">Other:</label>
                            <input type="number" id="cong18Oth" name="cong18Oth" value="0"><br><br>
                        </td>
                        <td>
                            <p><b>Demographic Data:</b></p>
                            <label for="whiteVotePop" style="padding-right: 20px">White:</label>
                            <input type="number" id="whiteVotePop" name="whiteVotePop" value="0"><br><br>
                            <label for="blackVotePop" style="padding-right: 20px">Black:</label>
                            <input type="number" id="blackVotePop" name="blackVotePop" value="0"><br><br>
                            <label for="asianVotePop" style="padding-right: 20px">Asian:</label>
                            <input type="number" id="asianVotePop" name="asianVotePop" value="0"><br><br>
                            <label for="hispanicVotePop">Hispanic:</label>
                            <input type="number" id="hispanicVotePop" name="hispanicVotePop" value="0"><br><br>
                            <label for="otherVotePop" style="padding-right: 20px">Other:</label>
                            <input type="number" id="otherVotePop" name="otherVotePop" value="0"><br><br>
                        </td>
                    </tr>
                </table>
                
                <center><button onclick="changePrecinctData()">Save</button></center>
            </div>
        </div>
        <!-- this is popup window for changing border -->
        <div id="bordersPopup" class="modal">
            <div class="modal-content">
                <button onclick="document.getElementById('bordersPopup').style.display='none'" style="float:right;">X</button>
                <label for="precinct1">Precinct to extend:</label>
                <select id="precinct1">
                    <option value="num1">precinct</option>
                    <option>precinct1</option>
                </select>
                <br>
                <br>
                <label for="precinct2">Precinct to connect to:</label>
                <select id="precinct2">
                    <option value="num2">precinct</option>
                    <option>precinct1</option>
                </select>
                <br><br>
                <center><button>Save</button></center>
            </div>
        </div>
        <!-- shows log of what user has done -->
        <div id="errorPopup" class="modal">
            <div class="modal-content">
                <button onclick="document.getElementById('errorPopup').style.display='none'" style="float:right;">X</button>
                <h4>Error Log</h4>
                <br><br>
                <div id="errorLog"></div>
            </div>
        </div>

        <div id="settingsPopup" class="modal">
            <div class="modal-content">
                <button onclick="document.getElementById('settingsPopup').style.display='none'" style="float:right;">X</button>
                <h4>Settings</h4>
                <br>
                <div>Map View Filter</div>
                <form>
                    <input type ="checkbox" id="congressional" value="congressional">
                    <label for="congressional">Congressional Data</label><br/>
                    <input type ="checkbox" id="nationalPark" value="national">
                    <label for="congressional">National Park Data</label>
                </form>
                <br/><br/>
                <table>
                    <tr> <td colspan="2">Election Data Color Change </td></tr>
                    <tr>
                        <td><label>Democrat: </label></td>
                        <td><input type="color" id="demColor" onchange="changeAllColor();" name="demColor" value="#0066ff"></td>
                    </tr>
                    <tr>
                        <td><label>Republican: </label></td>
                        <td><input type="color" id="repColor" onchange="changeAllColor()" name="repCcolor" value="#ff0000"></td>
                    </tr>
                    <tr>
                        <td><label>Other: </label></td>
                        <td><input type="color" id="otherColor" onchange="changeAllColor()" name="otherColor" value="#33cc33"></td>
                    </tr>
                    
                    <tr><td colspan="2"><br/>Demographic Data Color Change </td></tr>
                    <tr>
                        <td><label>White: </label></td>
                        <td><input type="color" id="whiteColor" onchange="changeAllColor()" name="whiteColor" value="#0066ff"></td>
                    </tr>
                    <tr> 
                        <td><label>Black: </label></td>
                        <td><input type="color" id="blackColor" onchange="changeAllColor()" name="blackColor" value="#ff0000"></td>
                    </tr>
                    <tr> 
                        <td><label>Asian: </label></td>
                        <td><input type="color" id="asianColor" onchange="changeAllColor()" name="asianColor" value="#cc99ff"></td>
                    </tr>
                    <tr> 
                        <td><label>Hispanic: </label></td>
                        <td><input type="color" id="hisColor" onchange="changeAllColor()" name="hisColor" value="#ffcc99"></td>
                    </tr>
                    <tr> 
                        <td><label>Other: </label></td>
                        <td><input type="color" id="restColor" onchange="changeAllColor()" name="restColor" value="#ffbf00"></td>
                    </tr>
                </table>
            </div>
        </div>
    </body>
    <script>
        function addResolvedError(precinctName){
            let today = new Date();
            let dateTime = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate()+" "+today.getHours() + ":" + today.getMinutes()+":"+today.getSeconds();
            let comment="["+dateTime+"] >>"+document.getElementById("commentArea").value+"<br/>";
            document.getElementById("commentArea").value="";
            addError({"dateTime":dateTime,"comment":document.getElementById("commentArea").value});
            document.getElementById("errorLog").innerHTML+="<div style=\'border-style:solid\'>Error Resolved on: "+precinctName+" from ERROR. <br/> Optional Comment: "+comment+"</div><br/>";
        }
        //change button
        function openChangeDataSection(){
            let dropdownValue=document.getElementById("Precincts").value;
            document.getElementById('precinctName').value = dropdownValue;
            if(dropdownValue!="precinct"){
                document.getElementById('changeDataSection').style.display='block';
            }
            fillChangeData();
        }
        
        //demographics
        function fillChangeData(){
            let selectedValue=document.getElementById("Precincts").value;
            if(selectedValue=="precinct") return;
            let selectedLayer=precinctLayers[selectedValue];
            let selectedFeature=selectedLayer.feature;
            document.getElementById("pred16Dem").value=selectedFeature.properties.demvotpres;
            document.getElementById("pred16Rep").value=selectedFeature.properties.repvotpres;
            document.getElementById("cong16Dem").value=selectedFeature.properties.demvot16;
            document.getElementById("cong16Rep").value=selectedFeature.properties.repvot16;
            document.getElementById("cong18Dem").value=selectedFeature.properties.demvot18;
            document.getElementById("cong18Rep").value=selectedFeature.properties.repvot18;
            document.getElementById("whiteVotePop").value=Math.floor(selectedFeature.properties.whiteov18);
            document.getElementById("blackVotePop").value=Math.floor(selectedFeature.properties.blackov18);
            document.getElementById("asianVotePop").value=Math.floor(selectedFeature.properties.asianov18);
            document.getElementById("hispanicVotePop").value=Math.floor(selectedFeature.properties.hisov18);
            document.getElementById("otherVotePop").value=Math.floor(selectedFeature.properties.otherov18);
        }
        function switchDataSection(){
            if(document.getElementById("dataSection").value == "election"){
                document.getElementById('electionSection').style.display = "block";
                document.getElementById('demographicSection').style.display = "none";
            }
            if(document.getElementById("dataSection").value == "demographic"){
                document.getElementById('electionSection').style.display = "none";
                document.getElementById('demographicSection').style.display = "block";
            }
        }
        function zoomOut(){
            let usaCoords=[39.436192999314095,-98.26171875];
            let usaZoomLevel=4;
            mymap.setView(new L.LatLng(usaCoords[0],usaCoords[1]), usaZoomLevel);
        }
        function initLoad(){
            //L is an object that represents the library and its functions that are available.
            mymap = L.map('forMap').setView([39.436192999314095, -98.26171875], 4);
            L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1,
            accessToken: 'pk.eyJ1IjoiZTE1MzEwODgiLCJhIjoiY2s3NzdjOWl3MDRzdTNmcWtqdDNlamxhNiJ9.aN5tSOOA7nNJA0KCnOITBA'}).addTo(mymap);
            precLayer=L.geoJSON(null,{onEachFeature: onEachFeature}).addTo(mymap);
            
            console.log("Hello, World!");
            loadFeature();
        }
        function loadFeature(stateName){
            console.log(stateName);
            //0 is rhodeisland,1 is north carolina, 2 is arizona
            let stateCoords=[[41.5801,-71.4774]];
            let zoomLevel=[9];
            let stateID=[44];
            precLayer.clearLayers();
            precinctLayers={};
            clearBothSections();
            document.getElementById("Precincts").innerHTML="<option value='precinct'>Precinct</option>";
                    document.getElementById("precinctDropdown").style.display="inline";
            switch(stateName){
                case "Rhode Island":
                    //loadErrorsForState(stateID[0]);
                    loadPrecinctsForState(stateID[0],stateCoords[0],zoomLevel[0])
                    break;
                default:
                    document.getElementById("precinctDropdown").style.display="none";
                    loadStateForMap();
                    zoomOut();
                    break;
            }
        }
        function loadErrorsForState(state_id){
            let xhr_error_data=new XMLHttpRequest();
            xhr_error_data.open('GET','http://localhost:8080/errors/'+state_id);
            xhr_error_data.onload=()=> {
                let error_data=JSON.parse(xhr_error_data.response);
                console.log(error_data);
            }
            xhr_error_data.send();
        }
        function loadStateForMap(){
            let xhr_ri_state=new XMLHttpRequest();
            xhr_ri_state.open('GET','http://localhost:8080/json_ri_state');
            xhr_ri_state.onload=()=>{
                let data=JSON.parse(xhr_ri_state.response);
                L.geoJSON(data,{style:setShapeColor(this,"STATE_STYLE")}).addTo(mymap);
            };
            xhr_ri_state.send();
        }
        function loadPrecinctsForState(state_id,riCoords,zoomLevel){
            mymap.setView(new L.LatLng(riCoords[0],riCoords[1]), zoomLevel);
            let xhr_precinct_data=new XMLHttpRequest();
            xhr_precinct_data.open('GET','http://localhost:8080/precincts/'+state_id);
            xhr_precinct_data.onload=()=> {
                let precinct_data=JSON.parse(xhr_precinct_data.response);
                for(i=0;i<precinct_data.length;i++){
                    precLayer.addData(prepareFeatureToUse(precinct_data));
                }
                loadPrecinctDictionary();
            }
            xhr_precinct_data.send();
        }
        initLoad();
        function prepareFeatureToUse(precinct_data){
            let jsonObj=JSON.parse(precinct_data[i]["shape_geojson"]);
            let newjsonObj={};
            newjsonObj["type"]="Feature";
            newjsonObj["properties"]={};
            newjsonObj.properties["aminov18"]=precinct_data[i]["aminov18"];
            newjsonObj.properties["asianov18"]=precinct_data[i]["asianov18"];
            newjsonObj.properties["blackov18"]=precinct_data[i]["blackov18"];
            newjsonObj.properties["demvot16"]=precinct_data[i]["demvot16"];
            newjsonObj.properties["demvot18"]=precinct_data[i]["demvot18"];
            newjsonObj.properties["demvotpres"]=precinct_data[i]["demvotpres"];
            newjsonObj.properties["hawov18"]=precinct_data[i]["hawov18"];
            newjsonObj.properties["hisov18"]=precinct_data[i]["hisov18"];
            newjsonObj.properties["name"]=precinct_data[i]["name"];
            newjsonObj.properties["otherov18"]=precinct_data[i]["otherov18"];
            newjsonObj.properties["othvot16"]=precinct_data[i]["othvot16"];
            newjsonObj.properties["othvot18"]=precinct_data[i]["othvot18"];
            newjsonObj.properties["othvotpres"]=precinct_data[i]["othvotpres"];
            newjsonObj.properties["pop100"]=precinct_data[i]["pop100"];
            newjsonObj.properties["repvot16"]=precinct_data[i]["repvot16"];
            newjsonObj.properties["repvot18"]=precinct_data[i]["repvot18"];
            newjsonObj.properties["repvotpres"]=precinct_data[i]["repvotpres"];
            newjsonObj.properties["whiteov18"]=precinct_data[i]["whiteov18"];
            newjsonObj.properties["ogrFID"]=precinct_data[i]["ogrFID"];
            newjsonObj.properties["totvotpres"]=precinct_data[i]["totvotpres"];
            newjsonObj.properties["totvot16"]=precinct_data[i]["totvot16"];
            newjsonObj.properties["totvot18"]=precinct_data[i]["totvot18"];
            newjsonObj.properties["statefp"]=precinct_data[i]["statefp"];
            newjsonObj["geometry"]={};
            newjsonObj.geometry["type"]=jsonObj["type"];
            newjsonObj.geometry["coordinates"]=jsonObj["coordinates"];
            return newjsonObj;
        }
        function loadPrecinctDictionary(){
            precinctLayers={};
            let precLayers=precLayer._layers;
            for (i in precLayers){
                let singleLayer=precLayers[i];
                let feature=singleLayer.feature;
                precinctLayers[feature.properties.name]=singleLayer;
            }
        }
        function setShapeColor(ft,shapeStyle){
            switch(shapeStyle){
                case "STATE_STYLE": 
                    return{
                        fillColor:'none',
                        weight:3,
                        color:'black'
                    };
                case "NEW_PREC_STYLE":
                    return{
                        fillOpacity: 0.8
                    };
                case "OLD_PREC_STYLE":
                    return{
                        fillOpacity: 0.2,
                        weight:3
                    };
                case "DEM_STYLE":
                    return{
                        color:document.getElementById("demColor").value
                    };
                case "REP_STYLE":
                    return{
                        color:document.getElementById("repColor").value
                    };
                case "GHOST_STYLE":
                    return{
                        color:'gray'
                    };
                case "ERROR_STYLE":
                    return{
                        color:'orange'
                    }
                default:
                    console.log(ft);
                    console.log("un-intended");
            }
        }
        function setNPS(e){
            this.setStyle(setShapeColor(this,"NEW_PREC_STYLE"));
        }
        function setOPS(e){
            this.setStyle(setShapeColor(this,"OLD_PREC_STYLE"));
        }
        function precinctZoom(precinctCenter,precinctSize){
            //console.log(precinctSize);
            let precinctZoomLevel=10.5;
            if(precinctSize<99999999) precinctZoomLevel=11;
            if(precinctSize<59999999) precinctZoomLevel=11.5;
            if(precinctSize<9999999) precinctZoomLevel=12;
            if(precinctSize<5999999) precinctZoomLevel=12.5;
            if(precinctSize<999999) precinctZoomLevel=13;
            if(precinctSize<599999) precinctZoomLevel=13.5;
            //console.log(precinctZoomLevel);
            let centerCoords=precinctCenter.geometry.coordinates;
            //resets center
            mymap.setView(new L.LatLng(0 ,0),precinctZoomLevel);
            mymap.setView(new L.LatLng(centerCoords[1],centerCoords[0]),precinctZoomLevel);
        }
        function setDemographicSection(feat){
            let whiteVotePop=feat.properties.whiteov18;
            let blackVotePop=feat.properties.blackov18;
            let asianVotePop=feat.properties.asianov18;
            let hispanicVotePop=feat.properties.hisov18;
            let otherVotePop=feat.properties.otherov18;
            let totVotePop=feat.properties.pop100;

            document.getElementById("whiteNum").innerHTML=Math.floor(whiteVotePop);
            document.getElementById("blackNum").innerHTML=Math.floor(blackVotePop);
            document.getElementById("asianNum").innerHTML=Math.floor(asianVotePop);
            document.getElementById("hispanicNum").innerHTML=Math.floor(hispanicVotePop);
            document.getElementById("otherNum").innerHTML=Math.floor(otherVotePop);
            document.getElementById("totVotePop").innerHTML=Math.floor(totVotePop);
        }
        function setElectionSection(){
            let dropdownValue=document.getElementById("Precincts").value;
            if(dropdownValue=="precinct") return;
            let selectedLayer=precinctLayers[dropdownValue];
            let selectedFeature=selectedLayer.feature;
            let pred16D=selectedFeature.properties.demvotpres;
            let pred16R=selectedFeature.properties.repvotpres;
            let pred16O=selectedFeature.properties.othvotpres;
            let cong16D=selectedFeature.properties.demvot16;
            let cong16R=selectedFeature.properties.repvot16;
            let cong16O=selectedFeature.properties.othvot16;
            let cong18D=selectedFeature.properties.demvot18;
            let cong18R=selectedFeature.properties.repvot18;
            let cong18O=selectedFeature.properties.othvot18;
            let pred16T=selectedFeature.properties.totvotpres;
            let cong16T=selectedFeature.properties.totvot16;
            let cong18T=selectedFeature.properties.totvot18;

            let dropdownYear = document.getElementById("year");
            if(dropdownYear.options[dropdownYear.selectedIndex].value == "pred16"){
                document.getElementById("totVotePop").innerHTML=pred16T + " people";
                if(pred16T==0)document.getElementById("demNum").innerHTML = 0 + " people [0%]";
                else document.getElementById("demNum").innerHTML = pred16D+ " people ["+Math.round(100*(pred16D/pred16T)) +"%]";
                if(pred16T==0) document.getElementById("repNum").innerHTML = 0 + " people [0%]";
                else document.getElementById("repNum").innerHTML = pred16R+ " people ["+Math.round(100*(pred16R/pred16T)) +"%]";
            }
            else if(dropdownYear.options[dropdownYear.selectedIndex].value == "cong16"){
                document.getElementById("demNum").innerHTML = cong16D;
                document.getElementById("repNum").innerHTML = cong16R;
                document.getElementById("totVotePop").innerHTML=cong16T + " people";
            }
            else{
                document.getElementById("demNum").innerHTML = cong18D;
                document.getElementById("repNum").innerHTML = cong18R;
                document.getElementById("totVotePop").innerHTML=cong18T + " people";
            }
        }
        function clearBothSections(){
            document.getElementById("whiteNum").innerHTML="N/A";
            document.getElementById("blackNum").innerHTML="N/A";
            document.getElementById("asianNum").innerHTML="N/A";
            document.getElementById("hispanicNum").innerHTML="N/A";
            document.getElementById("otherNum").innerHTML="N/A";
            document.getElementById("totVotePop").innerHTML="N/A";
            document.getElementById("demNum").innerHTML ="N/A";
            document.getElementById("repNum").innerHTML ="N/A";
            document.getElementById("othNum").innerHTML ="N/A";
        }
        function precMenuChange(selectedValue){
            if(selectedValue==undefined){
                selectedValue=document.getElementById("Precincts").value;
            }
            console.log(selectedValue);
            let selectedLayer=precinctLayers[selectedValue];
            let selectedFeature=selectedLayer.feature;
            
            showPrecinctOnClick(selectedLayer,selectedFeature);
            selectedLayer.openPopup();
        }
        function showPrecinctOnClick(selectedLayer,selectedFeature){
            precinctZoom(turf.centroid(selectedFeature),turf.area(selectedFeature));
            selectedLayer.bindPopup('<h1>' + selectedFeature.properties.name + '</h1>');
            setDemographicSection(selectedFeature);
            setElectionSection(selectedFeature);
            useErrorType(selectedFeature,selectedLayer);
        }
        function changeAllColor(){
            for(i in precinctLayers){
                let singleLayer=precinctLayers[i];
                let feature=singleLayer.feature;
                changeFeatColor(feature,singleLayer);
            }
        }
        function changeFeatColor(ft,tLayer){
            if(ft.properties.demvotpres ==0 && ft.properties.repvotpres == 0){
                tLayer.setStyle(setShapeColor(tLayer,"ERROR_STYLE"));
            }
            else{
                if(ft.properties.demvotpres>ft.properties.repvotpres){
                    tLayer.setStyle(setShapeColor(tLayer,"DEM_STYLE"));
                }
                if(ft.properties.demvotpres<=ft.properties.repvotpres){
                    tLayer.setStyle(setShapeColor(tLayer,"REP_STYLE"));
                }
                if(ft.properties.name=="Burrillville 0302" && ft.geometry.type=="MultiPolygon"){
                    tLayer.setStyle(setShapeColor(tLayer,"ERROR_STYLE"));
                }
            }
        }
        function onClick(e){
            let selectedLayer=e.target;
            let featInLayer=selectedLayer.feature;
            let dropdown = document.getElementById("Precincts");
            dropdown.value = featInLayer.properties.name;
            showPrecinctOnClick(selectedLayer,featInLayer);
        }
        function useErrorType(feat,layer){
            if(feat.properties.demvotpres ==0 && feat.properties.repvotpres == 0 && layer.options.color=="orange"){
                showError(layer,"GHOST");
            }
            else{
                if(feat.properties.name=="Burrillville 0302" && layer.options.color=="orange"){
                    showError(layer,"DONUT");
                }
                else{
                    showError(layer);
                }
            }
        }
        function addError(data){
            let xhr=new XMLHttpRequest();
            xhr.open('POST','http://localhost:8080/precincts');
            if(data){
                xhr.setRequestHeader('Content-Type','application/json');
            }
            data=JSON.stringify(data);
            xhr.send(data);
        }
        function setGhostPrecinct(layer){
            let feature=layer.feature;
            let featureID=feature.properties.ogrFID;
            let buttonToBeDeleted=document.getElementById(feature.properties.name+"_error");
            buttonToBeDeleted.parentNode.removeChild(buttonToBeDeleted);
            let errorDiv=document.getElementById("currentError");
            layer.setStyle(setShapeColor(layer,"GHOST_STYLE"));
            errorDiv.innerHTML="";
            document.getElementById("errorSection").style.display="none";
            //changes the type of error
            updatePrecinct(featureID,prepareFeatureToSend(feature));
            deleteError(feature.properties.name);
            addResolvedError(feature.properties.name);
        }
        function updatePrecinct(selectedID,newData){
            let xhr=new XMLHttpRequest();
            xhr.open('PUT','http://localhost:8080/precincts/'+selectedID);
            if(newData){
                xhr.setRequestHeader('Content-Type','application/json');
            }
            let data=JSON.stringify(newData);
            console.log(data);
            xhr.send(data);
        }
        function prepareFeatureToSend(feature){
            let jsonObj={};
            jsonObj["aminov18"]=feature.properties.aminov18;
            jsonObj["asianov18"]=feature.properties.asianov18;
            jsonObj["blackov18"]=feature.properties.blackov18;
            jsonObj["demvot16"]=feature.properties.demvot16;
            jsonObj["demvot18"]=feature.properties.demvot18;
            jsonObj["demvotpres"]=feature.properties.demvotpres;
            jsonObj["hawov18"]=feature.properties.hawov18;
            jsonObj["hisov18"]=feature.properties.hisov18;
            jsonObj["name"]=feature.properties.name;
            jsonObj["otherov18"]=feature.properties.otherov18;
            jsonObj["othvot16"]=feature.properties.othvot16;
            jsonObj["othvot18"]=feature.properties.othvot18;
            jsonObj["othvotpres"]=feature.properties.othvotpres;
            jsonObj["pop100"]=feature.properties.pop100;
            jsonObj["statefp"]=feature.properties.statefp;
            jsonObj["totvotpres"]=feature.properties.totvotpres;
            jsonObj["totvot16"]=feature.properties.totvot16;
            jsonObj["totvot18"]=feature.properties.totvot18;
            jsonObj["repvot16"]=feature.properties.repvot16;
            jsonObj["repvot18"]=feature.properties.repvot18;
            jsonObj["repvotpres"]=feature.properties.repvotpres;
            jsonObj["shape_geojson"]=JSON.stringify(feature.geometry);
            return jsonObj;
        }
        function deleteError(precinctName){
            let xhr=new XMLHttpRequest();
            xhr.open('DELETE','http://localhost:8080/errors/'+precinctName);
            xhr.send();
        }
        function mergePrecincts(layer){
            let feature=layer.feature;
            let buttonToBeDeleted=document.getElementById(feature.properties.name+"_error");
            buttonToBeDeleted.parentNode.removeChild(buttonToBeDeleted);
            let errorDiv=document.getElementById("currentError");
            errorDiv.innerHTML="";
            document.getElementById("errorSection").style.display="none";
            
            console.log(feature);
            let newPrecinct={"type":"Feature",
                "properties":feature.properties,
                "geometry":{
                    "type":"Polygon",
                    "coordinates":[feature.geometry.coordinates[0][0]]
                }
            };
            let dropdown = document.getElementById("Precincts");
            dropdown.remove(dropdown.selectedIndex);
            layer.remove();
            precLayer.removeLayer(layer);
            precLayer.addData(newPrecinct);
            
            updatePrecinct(feature.properties.ogrFID,newPrecinct);
            deleteError(newPrecinct.properties.name);
            addResolvedError(newFeature.properties.name);
        }
        function showError(layer,errorType){
            let featureName=layer.feature.properties.name;
            let errorDiv=document.getElementById("currentError");
            switch(errorType){
                case "GHOST":
                    document.getElementById("errorSection").style.display="block";
                    errorDiv.innerHTML="Ghost Precinct? <br>\n\
                        <button onclick='setGhostPrecinct(precinctLayers[\""+featureName+"\"])'>Yes</button>\n\
                        <button onclick='openChangeDataSection();errorDiv.innerHTML=\"\"'>No</button>";
                    break;
                case "DONUT":
                    document.getElementById("errorSection").style.display="block";
                    errorDiv.innerHTML="Merge Precinct<br>\n\
                        <button onclick='mergePrecincts(precinctLayers[\""+featureName+"\"])'>Yes</button>";
                    break;
                default:
                    document.getElementById("errorSection").style.display="none";
                    errorDiv.innerHTML="";
            }
        }
        function changePrecinctData(){
            let pred16Dem=document.getElementById("pred16Dem").value;
            let pred16Rep=document.getElementById("pred16Rep").value;
            let cong16Dem=document.getElementById("cong16Dem").value;
            let cong16Rep=document.getElementById("cong16Rep").value;
            let cong18Dem=document.getElementById("cong18Dem").value;
            let cong18Rep=document.getElementById("cong18Rep").value;
            let whiteVotePop=document.getElementById("whiteVotePop").value;
            let blackVotePop=document.getElementById("blackVotePop").value;
            let asianVotePop=document.getElementById("asianVotePop").value;
            let hispanicVotePop=document.getElementById("hispanicVotePop").value;
            let otherVotePop=document.getElementById("otherVotePop").value;
            
            let selectedValue=document.getElementById("Precincts").value;
            let selectedLayer=precinctLayers[selectedValue];
            let selectedFeature=selectedLayer.feature;
            let selectedID=selectedFeature.properties.ogrFID;
            changePrecinctVotingData(selectedFeature,pred16Dem,pred16Rep,cong16Dem,cong16Rep,cong18Dem,cong18Rep);
            changePrecinctDemographicData(selectedFeature,whiteVotePop,blackVotePop,asianVotePop,hispanicVotePop,otherVotePop);
            
            //changes the name of the feature, removes the name off the dropdown, and adds the new name in
            selectedLayer.closePopup();
            if(selectedValue!=document.getElementById("precinctName").value){
                selectedFeature.properties.name=document.getElementById("precinctName").value;
                precinctLayers[selectedFeature.properties.name]=precinctLayers[selectedValue];
                delete precinctLayers[selectedValue];
                let dropdown = document.getElementById("Precincts");
                dropdown.remove(dropdown.selectedIndex);
                let option = document.createElement("option");
                option.text = selectedFeature.properties.name;
                dropdown.add(option);
                dropdown.value=selectedFeature.properties.name;
                console.log(dropdown.value);
                console.log(selectedFeature);
            }
            showPrecinctOnClick(selectedLayer,selectedFeature);
            selectedLayer.openPopup();
            
            changeFeatColor(selectedLayer.feature,selectedLayer);
            if(selectedFeature.properties.name=="Voting Districts Not Defined" && document.getElementById("pred16Dem").value!=0){
                deleteError(selectedFeature.properties.name);
                addResolvedError(newFeature.properties.name);
            }
            let selectedError=document.getElementById(selectedValue+"_error");
            if(selectedError!=undefined){
                selectedError.parentNode.removeChild(selectedError);
                document.getElementById("currentError").innerHTML="";
                document.getElementById("errorSection").style.display="none";
            }
            document.getElementById('changeDataSection').style.display='none';
            updatePrecinct(selectedID,prepareFeatureToSend(selectedFeature));
        }
	function changePrecinctDemographicData(feature,whiteVotePop,blackVotePop,asianVotePop,hispanicVotePop,otherVotePop){
            feature.properties.whiteov18=parseInt(whiteVotePop);
            feature.properties.blackov18=parseInt(blackVotePop);
            feature.properties.asianov18=parseInt(asianVotePop);
            feature.properties.hisov18=parseInt(hispanicVotePop);
            feature.properties.otherov18=parseInt(otherVotePop);
	}
        function changePrecinctVotingData(feature,pred16Dem,pred16Rep,cong16Dem,cong16Rep,cong18Dem,cong18Rep){
            feature.properties.demvotpres=parseInt(pred16Dem);
            feature.properties.repvotpres=parseInt(pred16Rep);
            feature.properties.demvot16=parseInt(cong16Dem);
            feature.properties.repvot16=parseInt(cong16Rep);
            feature.properties.demvot18=parseInt(cong18Dem);
            feature.properties.repvot18=parseInt(cong18Rep);
        }
        function onEachFeature(feature,layer){
            layer.bindPopup('<h1>' + feature.properties.name + '</h1>');
            loadPrecincts(feature, layer);
            layer.on({
                click: onClick,
                mouseover: setNPS,
                mouseout: setOPS
            });
            if(feature.properties.demvotpres ==0 && feature.properties.repvotpres == 0 && layer.options.color=="#3388ff"){
               document.getElementById("errorLog").innerHTML+="<div id=\""+feature.properties.name+"_error\"><button onclick='document.getElementById(\"errorPopup\").style.display=\"none\";precMenuChange(\""+feature.properties.name+"\");'>Ghost Precinct Found ["+feature.properties.name+"](Requires Verification)</button></div>";
            }
            if(feature.properties.name=="Burrillville 0302" && feature.geometry.type=="MultiPolygon"){
               document.getElementById("errorLog").innerHTML+="<div id=\""+feature.properties.name+"_error\"><button onclick='document.getElementById(\"errorPopup\").style.display=\"none\";precMenuChange(\""+feature.properties.name+"\");'>Donut Precinct Found ["+feature.properties.name
                       +"](Requires Modification)</button></div>";
            }
            changeFeatColor(feature,layer);
        }
        function loadPrecincts(feature, layer){
            let dropdown = document.getElementById("Precincts");
            let addedPrecinct = document.createElement("option");
            let precinctName = feature.properties.name;
            addedPrecinct.text = precinctName;
            addedPrecinct.value = precinctName;
            dropdown.options.add(addedPrecinct);
        }
    </script>
</html>
